<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Settings</title>
<link rel="stylesheet" href="shared.css">
<style>
  :root {
    --bg-input: #2A2A2A;
    --bg-hover: #333333;
    --text-muted: #5A5A5A;
    --radius: 5px;
    --bg-section: #242424;
  }

  body { padding: 0; }

  .content-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 12px 16px 12px;
    overflow: hidden;
    min-height: 0;
  }

  /* ── Scroll area ── */
  .settings-content {
    flex: 1;
    overflow-y: auto;
    min-height: 0;
    padding-right: 2px;
  }

  /* ── Section ── */
  .section {
    margin-bottom: 14px;
    background: var(--bg-section);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .section-header {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-secondary);
    padding: 8px 12px 7px;
    background: rgba(255,255,255,0.03);
    border-bottom: 1px solid var(--border);
  }

  .section-body {
    padding: 10px 12px 12px;
  }

  .section-desc {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 10px;
    line-height: 1.4;
  }

  .setting-row {
    margin-bottom: 10px;
  }
  .setting-row:last-child { margin-bottom: 0; }

  label {
    display: block;
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 5px;
  }

  /* ── Inputs ── */
  select, input[type="text"], input[type="password"] {
    width: 100%;
    background: var(--bg-input);
    color: var(--text-primary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 6px 8px;
    font-family: var(--font-ui);
    font-size: 13px;
    outline: none;
    user-select: text;
    transition: border-color 0.12s;
  }
  select:focus, input[type="text"]:focus,
  input[type="password"]:focus {
    border-color: var(--border-focus);
    box-shadow: 0 0 0 2px var(--accent-dim);
  }
  /* ── Toggle switch ── */
  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 3px 0;
  }
  .toggle-text {
    font-size: 13px;
    color: var(--text-primary);
  }
  .toggle-sub {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 2px;
  }
  .toggle-switch {
    position: relative;
    width: 36px;
    height: 20px;
    flex-shrink: 0;
  }
  .toggle-switch input {
    opacity: 0; width: 0; height: 0; position: absolute;
  }
  .toggle-knob {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: #444;
    border-radius: 20px;
    transition: background 0.2s;
  }
  .toggle-knob::before {
    content: '';
    position: absolute;
    width: 14px; height: 14px;
    left: 3px; bottom: 3px;
    background: #ccc;
    border-radius: 50%;
    transition: transform 0.2s, background 0.2s;
  }
  .toggle-switch input:checked + .toggle-knob {
    background: var(--accent);
  }
  .toggle-switch input:checked + .toggle-knob::before {
    transform: translateX(16px);
    background: #fff;
  }

  /* ── Provider ── */
  .provider-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .provider-row select { flex: 1; }
  .provider-note {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 6px;
  }

  /* ── API Keys ── */
  .key-grid { display: grid; grid-template-columns: 1fr; gap: 7px; }
  .key-row {
    display: grid;
    grid-template-columns: 88px 1fr;
    align-items: center;
    gap: 8px;
  }
  .key-label {
    font-size: 12px;
    color: var(--text-secondary);
  }
  .key-input-wrap {
    position: relative;
    display: flex;
    align-items: center;
  }
  .key-input {
    font-family: var(--font-mono);
    font-size: 12px;
    flex: 1;
    padding-right: 30px !important;
  }
  .eye-btn {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 28px;
    background: transparent;
    border: none;
    border-left: 1px solid var(--border);
    border-radius: 0 var(--radius) var(--radius) 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    padding: 0;
    transition: color 0.15s, background 0.15s;
    outline: none;
  }
  .eye-btn:hover { color: var(--text-secondary); background: var(--bg-hover); }
  .eye-btn svg { display: block; }

  /* ── Model picker ── */
  .model-picker { position: relative; }
  #model-dropdown {
    position: absolute;
    top: 100%; left: 0; right: 0;
    background: var(--bg-dropdown);
    border: 1px solid var(--border);
    border-top: none;
    border-radius: 0 0 var(--radius) var(--radius);
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    display: none;
  }
  #model-dropdown.visible { display: block; }
  .dropdown-item {
    padding: 6px 10px;
    cursor: pointer;
    font-size: 13px;
    color: var(--text-primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .dropdown-item:hover, .dropdown-item.active {
    background: var(--bg-hover);
    color: #fff;
  }
  .dropdown-item .model-id { font-family: var(--font-mono); font-size: 12px; }
  .dropdown-item .model-name {
    font-size: 11px;
    color: var(--text-muted);
    margin-left: 12px;
    flex-shrink: 0;
  }
  .current-model {
    margin-top: 7px;
    font-size: 12px;
    color: var(--text-secondary);
  }
  .current-model span { color: var(--accent); font-family: var(--font-mono); }

  /* ── Hotkeys ── */
  .hotkey-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 7px;
  }
  .hotkey-row:last-child { margin-bottom: 0; }
  .hotkey-label {
    width: 120px;
    font-size: 12px;
    color: var(--text-secondary);
    flex-shrink: 0;
  }
  .hotkey-input {
    flex: 1;
    background: var(--bg-input);
    color: var(--text-primary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 6px 8px;
    font-family: var(--font-mono);
    font-size: 12px;
    outline: none;
    cursor: pointer;
    text-align: center;
    transition: border-color 0.12s;
  }
  .hotkey-input:focus { border-color: var(--accent); background: #1e1e2a; }
  .hotkey-input::placeholder { color: var(--text-muted); font-style: italic; }
  .hotkey-clear {
    padding: 4px 8px;
    font-size: 11px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    flex-shrink: 0;
    transition: color 0.15s, background 0.15s;
  }
  .hotkey-clear:hover { background: var(--bg-hover); color: var(--text-primary); }

  /* ── Footer ── */
  .footer {
    flex-shrink: 0;
    padding-top: 10px;
    border-top: 1px solid var(--border);
    margin-top: 2px;
  }
  .button-row {
    display: flex;
    justify-content: flex-end;
    gap: 7px;
    margin-bottom: 6px;
  }
  button {
    padding: 6px 14px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg-input);
    color: var(--text-primary);
    font-family: var(--font-ui);
    font-size: 12px;
    cursor: pointer;
    outline: none;
    transition: background 0.12s, border-color 0.12s;
  }
  button:hover { background: var(--bg-hover); border-color: #444; }
  button.primary {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
    font-weight: 600;
  }
  button.primary:hover { background: var(--accent-hover); border-color: var(--accent-hover); }

  #status {
    font-size: 11px;
    color: var(--text-muted);
    text-align: right;
    min-height: 14px;
  }

  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #3a3a3a; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #4a4a4a; }
</style>
</head>
<body>

  <div class="titlebar">
    <div class="grip"><span></span><span></span><span></span><span></span><span></span><span></span></div>
    <div class="titlebar-title"><span class="titlebar-icon">⚙</span> Settings</div>
    <div class="window-controls">
      <button class="win-btn win-minimize" onclick="minimizeWindow()">&#x2212;</button>
      <button class="win-btn win-close" onclick="closeWindow()">&#x2715;</button>
    </div>
  </div>

  <div class="content-area">
  <div class="settings-content">

    <!-- General -->
    <div class="section">
      <div class="section-header">General</div>
      <div class="section-body">
        <div class="toggle-row">
          <div>
            <div class="toggle-text">Launch at Windows startup</div>
          </div>
          <label class="toggle-switch" title="Register app in Windows startup">
            <input type="checkbox" id="autostart-toggle">
            <span class="toggle-knob"></span>
          </label>
        </div>
      </div>
    </div>

    <!-- Provider -->
    <div class="section">
      <div class="section-header">Provider</div>
      <div class="section-body">
        <div class="section-desc">Choose which API provider the app uses by default.</div>
        <div class="setting-row provider-row">
          <select id="provider-select">
            <option value="openrouter">OpenRouter</option>
            <option value="openai">OpenAI</option>
            <option value="anthropic">Anthropic</option>
            <option value="xai">xAI</option>
          </select>
        </div>
        <div class="provider-note" id="provider-note"></div>
      </div>
    </div>

    <!-- API Keys -->
    <div class="section">
      <div class="section-header">API Keys</div>
      <div class="section-body">
        <div class="section-desc">Saved keys override values from <code style="font-family:var(--font-mono);font-size:11px;color:var(--text-secondary)">.env</code>.</div>
        <div class="key-grid">
          <div class="key-row">
            <div class="key-label">OpenRouter</div>
            <div class="key-input-wrap">
              <input type="password" class="key-input" id="key-openrouter" placeholder="sk-or-v1-...">
              <button class="eye-btn" data-target="key-openrouter" tabindex="-1" title="Show/hide key">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 3C4.5 3 1.5 5.5 0 8c1.5 2.5 4.5 5 8 5s6.5-2.5 8-5c-1.5-2.5-4.5-5-8-5zm0 8a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0-5a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/></svg>
              </button>
            </div>
          </div>
          <div class="key-row">
            <div class="key-label">OpenAI</div>
            <div class="key-input-wrap">
              <input type="password" class="key-input" id="key-openai" placeholder="sk-proj-...">
              <button class="eye-btn" data-target="key-openai" tabindex="-1" title="Show/hide key">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 3C4.5 3 1.5 5.5 0 8c1.5 2.5 4.5 5 8 5s6.5-2.5 8-5c-1.5-2.5-4.5-5-8-5zm0 8a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0-5a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/></svg>
              </button>
            </div>
          </div>
          <div class="key-row">
            <div class="key-label">Anthropic</div>
            <div class="key-input-wrap">
              <input type="password" class="key-input" id="key-anthropic" placeholder="sk-ant-api03-...">
              <button class="eye-btn" data-target="key-anthropic" tabindex="-1" title="Show/hide key">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 3C4.5 3 1.5 5.5 0 8c1.5 2.5 4.5 5 8 5s6.5-2.5 8-5c-1.5-2.5-4.5-5-8-5zm0 8a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0-5a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/></svg>
              </button>
            </div>
          </div>
          <div class="key-row">
            <div class="key-label">xAI</div>
            <div class="key-input-wrap">
              <input type="password" class="key-input" id="key-xai" placeholder="xai-...">
              <button class="eye-btn" data-target="key-xai" tabindex="-1" title="Show/hide key">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 3C4.5 3 1.5 5.5 0 8c1.5 2.5 4.5 5 8 5s6.5-2.5 8-5c-1.5-2.5-4.5-5-8-5zm0 8a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0-5a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/></svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Default Model -->
    <div class="section">
      <div class="section-header">Default Model</div>
      <div class="section-body">
        <div class="section-desc">Used when a prompt does not specify a model override.</div>
        <div class="setting-row">
          <label>Search and select a model</label>
          <div class="model-picker">
            <input type="text" id="model-input" autocomplete="off" placeholder="Type to filter...">
            <div id="model-dropdown"></div>
          </div>
          <div class="current-model">Current: <span id="current-model-display">loading...</span></div>
        </div>
      </div>
    </div>

    <!-- Hotkeys -->
    <div class="section">
      <div class="section-header">Hotkeys</div>
      <div class="section-body">
        <div class="section-desc">Click a field and press a key combination to assign it.</div>
        <div id="hotkeys-container"></div>
      </div>
    </div>

  </div>

  <div class="footer">
    <div class="button-row">
      <button id="btn-refresh">Refresh models</button>
      <button id="btn-close">Close</button>
    </div>
    <div id="status">Loading...</div>
  </div>
  </div>

<script src="ahk-bridge.js"></script>
<script>
  // =============================================
  // STATE
  // =============================================
  let allModels = [];
  let filteredModels = [];
  let activeIndex = -1;
  let currentModelId = '';
  let currentProvider = 'openrouter';
  let hotkeyData = [];
  let recordingInput = null;

  // =============================================
  // DOM REFS
  // =============================================
  const providerSelect = document.getElementById('provider-select');
  const providerNote = document.getElementById('provider-note');
  const modelInput = document.getElementById('model-input');
  const modelDropdown = document.getElementById('model-dropdown');
  const currentModelDisplay = document.getElementById('current-model-display');
  const hotkeysContainer = document.getElementById('hotkeys-container');
  const statusEl = document.getElementById('status');
  const keyInputs = {
    openrouter: document.getElementById('key-openrouter'),
    openai: document.getElementById('key-openai'),
    anthropic: document.getElementById('key-anthropic'),
    xai: document.getElementById('key-xai')
  };

  // =============================================
  // HELPERS
  // =============================================
  function providerLabel(provider) {
    if (provider === 'openrouter') return 'OpenRouter';
    if (provider === 'openai') return 'OpenAI';
    if (provider === 'anthropic') return 'Anthropic';
    if (provider === 'xai') return 'xAI';
    return provider;
  }

  function escHtml(s) {
    s = String(s || '');
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function sendToAHK(action, data = {}) {
    postToAHK({ action, ...data });
  }

  function updateProviderNote() {
    providerNote.textContent = 'Current provider: ' + providerLabel(currentProvider);
  }

  // =============================================
  // AHK -> JS
  // =============================================
  function setCurrentProvider(provider) {
    currentProvider = provider || 'openrouter';
    providerSelect.value = currentProvider;
    updateProviderNote();
  }

  function setApiKeys(data) {
    if (typeof data === 'string') data = JSON.parse(data);
    keyInputs.openrouter.value = data.openrouter || '';
    keyInputs.openai.value = data.openai || '';
    keyInputs.anthropic.value = data.anthropic || '';
    keyInputs.xai.value = data.xai || '';
  }

  function setModels(models) {
    if (typeof models === 'string') models = JSON.parse(models);
    allModels = (models || []).map(m => ({
      id: m.id || '',
      name: m.name || m.id || ''
    }));
    filteredModels = [...allModels];
    renderDropdown();
    statusEl.textContent = allModels.length + ' models available for ' + providerLabel(currentProvider);
  }

  function setCurrentModel(modelId) {
    currentModelId = modelId || '';
    currentModelDisplay.textContent = currentModelId || 'none';
  }

  function setHotkeys(data) {
    if (typeof data === 'string') data = JSON.parse(data);
    hotkeyData = data || [];
    renderHotkeys();
  }

  function setAutostart(enabled) {
    document.getElementById('autostart-toggle').checked = !!enabled;
  }

  function setStatus(text) {
    statusEl.textContent = text;
  }

  // =============================================
  // EYE BUTTONS (show/hide API keys)
  // =============================================
  document.querySelectorAll('.eye-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const input = document.getElementById(btn.dataset.target);
      if (!input) return;
      input.type = input.type === 'password' ? 'text' : 'password';
      btn.style.color = input.type === 'text' ? 'var(--accent)' : '';
    });
  });

  // =============================================
  // HOTKEY RECORDING
  // =============================================
  function ahkToDisplay(ahk) {
    if (!ahk) return '';
    if (ahk.includes(',')) {
      const parts = ahk.split(',');
      const prefix = ahkToDisplaySingle(parts[0] || '');
      const suffix = ahkToDisplaySingle(parts.slice(1).join(',') || '');
      return prefix && suffix ? (prefix + ' -> ' + suffix) : (prefix || suffix);
    }
    return ahkToDisplaySingle(ahk);
  }

  function ahkToDisplaySingle(ahk) {
    if (!ahk) return '';
    let display = '';
    let rest = ahk;
    if (rest.includes('^')) { display += 'Ctrl+'; rest = rest.replace('^', ''); }
    if (rest.includes('!')) { display += 'Alt+'; rest = rest.replace('!', ''); }
    if (rest.includes('+')) { display += 'Shift+'; rest = rest.replace('+', ''); }
    if (rest.includes('#')) { display += 'Win+'; rest = rest.replace('#', ''); }
    if (rest.length === 1) rest = rest.toUpperCase();
    return display + rest;
  }

  function eventToAhk(e) {
    if (['Control', 'Alt', 'Shift', 'Meta'].includes(e.key)) return null;

    let ahk = '';
    if (e.ctrlKey) ahk += '^';
    if (e.altKey) ahk += '!';
    if (e.shiftKey) ahk += '+';

    const keyMap = {
      'F1': 'F1', 'F2': 'F2', 'F3': 'F3', 'F4': 'F4',
      'F5': 'F5', 'F6': 'F6', 'F7': 'F7', 'F8': 'F8',
      'F9': 'F9', 'F10': 'F10', 'F11': 'F11', 'F12': 'F12',
      'Escape': 'Esc', 'Enter': 'Enter', 'Tab': 'Tab',
      'Backspace': 'Backspace', 'Delete': 'Delete',
      'ArrowUp': 'Up', 'ArrowDown': 'Down',
      'ArrowLeft': 'Left', 'ArrowRight': 'Right',
      'Home': 'Home', 'End': 'End',
      'PageUp': 'PgUp', 'PageDown': 'PgDn',
      'Insert': 'Insert', ' ': 'Space'
    };

    const key = keyMap[e.key] || e.key.toLowerCase();
    return ahk + key;
  }

  function renderHotkeys() {
    hotkeysContainer.innerHTML = '';
    hotkeyData.forEach(item => {
      const row = document.createElement('div');
      row.className = 'hotkey-row';

      const label = document.createElement('span');
      label.className = 'hotkey-label';
      label.textContent = item.label;

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'hotkey-input';
      input.readOnly = true;
      input.value = ahkToDisplay(item.ahkKey);
      input.placeholder = 'Click to set...';
      input.dataset.actionId = item.id;
      input.dataset.ahkKey = item.ahkKey || '';

      input.addEventListener('focus', () => {
        recordingInput = input;
        input.value = 'Press a key combo...';
        sendToAHK('startRecording');
      });

      input.addEventListener('blur', () => {
        if (recordingInput === input) {
          recordingInput = null;
          input.value = ahkToDisplay(input.dataset.ahkKey);
        }
        sendToAHK('stopRecording');
      });

      input.addEventListener('keydown', (e) => {
        if (recordingInput !== input) return;
        e.preventDefault();
        e.stopPropagation();

        const ahk = eventToAhk(e);
        if (!ahk) return;

        input.dataset.ahkKey = ahk;
        input.value = ahkToDisplay(ahk);
        recordingInput = null;
        input.blur();

        const entry = hotkeyData.find(h => h.id === item.id);
        if (entry) entry.ahkKey = ahk;
        sendToAHK('hotkeyChanged', { id: item.id, key: ahk });
      });

      const clearBtn = document.createElement('button');
      clearBtn.className = 'hotkey-clear';
      clearBtn.textContent = 'Clear';
      clearBtn.addEventListener('click', () => {
        input.dataset.ahkKey = '';
        input.value = '';
        const entry = hotkeyData.find(h => h.id === item.id);
        if (entry) entry.ahkKey = '';
        sendToAHK('hotkeyChanged', { id: item.id, key: '' });
      });

      row.appendChild(label);
      row.appendChild(input);
      row.appendChild(clearBtn);
      hotkeysContainer.appendChild(row);
    });
  }

  // =============================================
  // MODEL PICKER
  // =============================================
  function renderDropdown() {
    modelDropdown.innerHTML = '';
    activeIndex = -1;
    filteredModels.forEach((model) => {
      const div = document.createElement('div');
      div.className = 'dropdown-item';
      div.innerHTML = '<span class="model-id">' + escHtml(model.id) + '</span>'
                    + '<span class="model-name">' + escHtml(model.name) + '</span>';
      div.addEventListener('mousedown', (e) => {
        e.preventDefault();
        selectModel(model.id);
      });
      modelDropdown.appendChild(div);
    });
  }

  function showDropdown() {
    if (filteredModels.length === 0) return;
    modelDropdown.classList.add('visible');
  }

  function hideDropdown() {
    modelDropdown.classList.remove('visible');
    activeIndex = -1;
  }

  function selectModel(id) {
    modelInput.value = '';
    hideDropdown();
    currentModelId = id;
    currentModelDisplay.textContent = id;
    sendToAHK('modelSelected');
  }

  function updateActiveItem() {
    const items = modelDropdown.querySelectorAll('.dropdown-item');
    items.forEach((item, i) => {
      item.classList.toggle('active', i === activeIndex);
    });
    if (activeIndex >= 0 && items[activeIndex]) {
      items[activeIndex].scrollIntoView({ block: 'nearest' });
    }
  }

  function filterModels() {
    const typed = modelInput.value.toLowerCase();
    if (typed === '') {
      filteredModels = [...allModels];
    } else {
      filteredModels = allModels.filter(m =>
        String(m.id || '').toLowerCase().includes(typed) || String(m.name || '').toLowerCase().includes(typed)
      );
    }
    renderDropdown();
    showDropdown();
  }

  modelInput.addEventListener('input', filterModels);
  modelInput.addEventListener('focus', () => { filterModels(); showDropdown(); });
  modelInput.addEventListener('blur', () => { setTimeout(hideDropdown, 150); });

  modelInput.addEventListener('keydown', (e) => {
    if (!modelDropdown.classList.contains('visible')) {
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        showDropdown();
        e.preventDefault();
      }
      return;
    }

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      activeIndex = Math.min(activeIndex + 1, filteredModels.length - 1);
      updateActiveItem();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      activeIndex = Math.max(activeIndex - 1, 0);
      updateActiveItem();
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (activeIndex >= 0 && filteredModels[activeIndex]) {
        selectModel(filteredModels[activeIndex].id);
      }
    } else if (e.key === 'Escape') {
      hideDropdown();
      e.stopPropagation();
    }
  });

  // =============================================
  // BUTTONS + EVENTS
  // =============================================
  document.getElementById('autostart-toggle').addEventListener('change', (e) => {
    sendToAHK('setAutostart', { enabled: e.target.checked });
  });

  providerSelect.addEventListener('change', () => {
    currentProvider = providerSelect.value;
    updateProviderNote();
    sendToAHK('providerSelected', { provider: currentProvider });
  });

  function saveApiKeys() {
    sendToAHK('saveApiKeys', {
      openrouterKey: keyInputs.openrouter.value.trim(),
      openaiKey: keyInputs.openai.value.trim(),
      anthropicKey: keyInputs.anthropic.value.trim(),
      xaiKey: keyInputs.xai.value.trim()
    });
  }

  Object.values(keyInputs).forEach(input => input.addEventListener('blur', saveApiKeys));

  document.getElementById('btn-refresh').addEventListener('click', () => {
    sendToAHK('refreshModels');
  });

  document.getElementById('btn-close').addEventListener('click', () => {
    sendToAHK('close');
  });

  // =============================================
  // KEYBOARD SHORTCUTS
  // =============================================
  document.addEventListener('keydown', (e) => {
    if (recordingInput) return;
    if (e.key === 'Escape' && !modelDropdown.classList.contains('visible')) {
      e.preventDefault();
      sendToAHK('close');
    }
  });

  // =============================================
  // READY SIGNAL
  // =============================================
  document.addEventListener('DOMContentLoaded', () => {
    updateProviderNote();
    sendToAHK('ready');
  });
</script>
</body>
</html>
